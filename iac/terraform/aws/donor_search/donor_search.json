{
  "Comment": "State machine for donor search process",
  "StartAt": "PrepareDonorSearch",
  "States": {
    "PrepareDonorSearch": {
      "Type": "Parallel",
      "Branches": [
        {
          "StartAt": "QueryDonorsFound",
          "States": {
            "QueryDonorsFound": {
              "Type": "Task",
              "Resource": "arn:aws:states:::aws-sdk:dynamodb:query",
              "Parameters": {
                "TableName": "${DYNAMODB_TABLE_NAME}",
                "KeyConditionExpression": "PK = :seekerId AND begins_with(SK, :requestPostId)",
                "ExpressionAttributeValues": {
                  ":seekerId": {
                    "S.$": "States.Format('BLOOD_REQ#{}', $.seekerId)"
                  },
                  ":requestPostId": {
                    "S.$": "States.Format('ACCEPTED#{}', $.requestPostId)"
                  }
                }
              },
              "ResultPath": "$.donorsFoundCount",
              "Next": "PerformCalculations"
            },
            "PerformCalculations": {
              "Type": "Task",
              "Resource": "${DONOR_CALCULATE_LAMBDA_ARN}",
              "Parameters": {
                "bloodQuantity.$": "$.bloodQuantity",
                "donorsFoundCount.$": "$.donorsFoundCount.Count",
                "urgencyLevel.$": "$.urgencyLevel",
                "donationDateTime.$": "$.donationDateTime",
                "retryCount.$": "$.retryCount"
              },
              "ResultPath": "$.calculationResults",
              "End": true
            }
          }
        }
      ],
      "ResultSelector": {
        "totalDonorsToNotify.$": "$.[0].calculationResults.totalDonorsToNotify",
        "geohash.$": "$.[0].geohash",
        "neededBloodGroup.$": "$.[0].neededBloodGroup",
        "city.$": "$.[0].city",
        "delayPeriod.$": "$.[0].calculationResults.delayPeriod"
      },
      "ResultPath": "$.prepareDonorSearchResult",
      "Next": "DonorSearchProcess"
    },
    "DonorSearchProcess": {
      "Type": "Parallel",
      "Branches": [
        {
          "StartAt": "CheckGeohash",
          "States": {
            "CheckGeohash": {
              "Type": "Choice",
              "Choices": [
                {
                  "Variable": "$.prepareDonorSearchResult.geohash",
                  "StringEquals": "",
                  "Next": "QueryEligibleDonorsWithoutGeohash"
                }
              ],
              "Default": "QueryEligibleDonorsWithGeohash"
            },
            "QueryEligibleDonorsWithGeohash": {
              "Type": "Task",
              "Resource": "arn:aws:states:::aws-sdk:dynamodb:query",
              "Parameters": {
                "TableName": "${DYNAMODB_TABLE_NAME}",
                "IndexName": "GSI1",
                "KeyConditionExpression": "GSI1PK = :cityAndBloodGroupAndStatus AND begins_with(GSI1SK, :geohash)",
                "ExpressionAttributeValues": {
                  ":cityAndBloodGroupAndStatus": {
                    "S.$": "States.Format('CITY#{}#BG#{}#DONATIONSTATUS#yes', $.city, $.neededBloodGroup)"
                  },
                  ":geohash": {
                    "S.$": "$.prepareDonorSearchResult.geohash"
                  }
                }
              },
              "ResultPath": "$.eligibleDonors",
              "Next": "CheckDonorStatus"
            },
            "QueryEligibleDonorsWithoutGeohash": {
              "Type": "Task",
              "Resource": "arn:aws:states:::aws-sdk:dynamodb:query",
              "Parameters": {
                "TableName": "${DYNAMODB_TABLE_NAME}",
                "IndexName": "GSI1",
                "KeyConditionExpression": "GSI1PK = :cityAndBloodGroupAndStatus",
                "ExpressionAttributeValues": {
                  ":cityAndBloodGroupAndStatus": {
                    "S.$": "States.Format('CITY#{}#BG#{}#DONATIONSTATUS#yes', $.city, $.neededBloodGroup)"
                  }
                }
              },
              "ResultPath": "$.eligibleDonors",
              "Next": "CheckDonorStatus"
            },
            "CheckDonorStatus": {
              "Type": "Task",
              "Resource": "${DONOR_SEARCH_EVALUATOR_LAMBDA_ARN}",
              "Parameters": {
                "geohash.$": "$.prepareDonorSearchResult.geohash",
                "eligibleDonorsCount.$": "$.eligibleDonors.Count",
                "totalDonorsToNotify.$": "$.prepareDonorSearchResult.totalDonorsToNotify",
                "eligibleDonors.$": "$.eligibleDonors.Items"
              },
              "ResultPath": "$.checkDonorSearchResult",
              "Next": "DecideNextStep"
            },
            "DecideNextStep": {
              "Type": "Choice",
              "Choices": [
                {
                  "Variable": "$.checkDonorSearchResult.action",
                  "StringEquals": "EnoughDonorsFound",
                  "Next": "EnoughDonorsFound"
                },
                {
                  "Variable": "$.checkDonorSearchResult.action",
                  "StringEquals": "UpdateSearchFields",
                  "Next": "UpdateSearchFields"
                }
              ],
              "Default": "EnoughDonorsFound"
            },
            "UpdateSearchFields": {
              "Type": "Pass",
              "Parameters": {
                "totalDonorsToNotify.$": "$.prepareDonorSearchResult.totalDonorsToNotify",
                "city.$": "$.prepareDonorSearchResult.city",
                "geohash.$": "$.checkDonorSearchResult.shortenedGeohash",
                "neededBloodGroup.$": "$.prepareDonorSearchResult.neededBloodGroup",
                "delayPeriod.$": "$.prepareDonorSearchResult.delayPeriod"
              },
              "ResultPath": "$.prepareDonorSearchResult",
              "Next": "CheckGeohash"
            },
            "EnoughDonorsFound": {
              "Type": "Succeed"
            }
          }
        }
      ],
      "ResultSelector": {
        "donorIds.$": "$.[0].checkDonorSearchResult.userIds"
      },
      "ResultPath": "$.donorSearchResult",
      "Next": "NotifyDonors"
    },
    "NotifyDonors": {
      "Type": "Map",
      "ItemsPath": "$.donorSearchResult.donorIds",
      "Parameters": {
        "donorId.$": "$$.Map.Item.Value",
        "seekerId.$": "$.seekerId",
        "requestPostId.$": "$.requestPostId",
        "createdAt.$": "$.createdAt",
        "seekerName.$": "$.seekerName",
        "patientName.$": "$.patientName",
        "location.$": "$.location",
        "contactNumber.$": "$.contactNumber",
        "transportationInfo.$": "$.transportationInfo",
        "shortDescription.$": "$.shortDescription",
        "neededBloodGroup.$": "$.neededBloodGroup",
        "bloodQuantity.$": "$.bloodQuantity",
        "urgencyLevel.$": "$.urgencyLevel",
        "donationDateTime.$": "$.donationDateTime",
        "message.$": "$.message"
      },
      "Iterator": {
        "StartAt": "SendDonorNotificationToSQS",
        "States": {
          "SendDonorNotificationToSQS": {
            "Type": "Task",
            "Resource": "arn:aws:states:::aws-sdk:sqs:sendMessage",
            "Parameters": {
              "QueueUrl": "${NOTIFICATION_QUEUE_URL}",
              "MessageBody": {
                "userId.$": "$.donorId",
                "title": "Blood Request",
                "body.$": "$.message",
                "type": "bloodRequestPost",
                "payload": {
                  "seekerId.$": "$.seekerId",
                  "requestPostId.$": "$.requestPostId",
                  "createdAt.$": "$.createdAt",
                  "seekerName.$": "$.seekerName",
                  "patientName.$": "$.patientName",
                  "neededBloodGroup.$": "$.neededBloodGroup",
                  "bloodQuantity.$": "$.bloodQuantity",
                  "urgencyLevel.$": "$.urgencyLevel",
                  "location.$": "$.location",
                  "contactNumber.$": "$.contactNumber",
                  "transportationInfo.$": "$.transportationInfo",
                  "shortDescription.$": "$.shortDescription",
                  "donationDateTime.$": "$.donationDateTime"
                }
              },
              "DelaySeconds": 0
            },
            "End": true
          }
        }
      },
      "ResultPath": "$.notifications",
      "Next": "SendSqsMessage"
    },
    "SendSqsMessage": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:sqs:sendMessage",
      "Parameters": {
        "QueueUrl": "${DONOR_SEARCH_RETRY_QUEUE_URL}",
        "MessageBody": {
          "PK.$": "States.Format('BLOOD_REQ#{}', $.seekerId)",
          "SK.$": "States.Format('BLOOD_REQ#{}#{}', $.createdAt, $.requestPostId)"
        },
        "DelaySeconds.$": "$.prepareDonorSearchResult.delayPeriod"
      },
      "End": true
    }
  }
}