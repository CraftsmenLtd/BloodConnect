name: "Branch Deployment"

on:
  workflow_dispatch:


jobs:

  set-deployment-environment:
    name: Set Deployment Environment
    runs-on: ubuntu-22.04
    outputs:
      deployment_environment: ${{ steps.set_deployment_env.outputs.deployment_environment }}
    steps:
      - name: Set Deployment Environment
        id: set_deployment_env
        run: echo "deployment_environment=$(echo "${{ github.ref }}" | sed -E 's#refs/heads/(.*)#\1#' | awk '{print tolower($0)}')" >> $GITHUB_OUTPUT

  branch-deployment:
    name: Branch Deployment
    needs: set-deployment-environment
    secrets: inherit
    uses: ./.github/workflows/aws-terraform.yml
    with:
      github_environment: dev
      deployment_environment: ${{ needs.set-deployment-environment.outputs.deployment_environment }}
      tf_backend_bucket_name: terraform-bloodconnect-ci-dev
      tf_backend_bucket_key: dev/${{ needs.set-deployment-environment.outputs.deployment_environment }}.tfstate
      tf_backend_bucket_region: ap-south-1
      aws_region: ap-south-1
      tf_action: apply
      tf_vars: |
        TF_VAR_aws_environment=${{ needs.set-deployment-environment.outputs.deployment_environment }}
