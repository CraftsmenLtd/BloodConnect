name: 📱 Mobile App Build

on:
  push:
    branches:
      - I-221-mobile-app-pipeline

permissions:
  contents: read
  packages: write

defaults:
  run:
    shell: bash
      
concurrency:
  group: ${{ github.ref }}

jobs:
  build-push-docker-image:
    name: 🐳 Build and Push Docker Image
    uses: ./.github/workflows/docker-image.yml
    secrets: inherit

  build-app:
    name: Build App
    needs: [build-push-docker-image]
    runs-on: ${{ vars.RUNNER_OS }}
    env:
      RUNNER_IMAGE_NAME: ${{ needs.build-push-docker-image.outputs.runner_image_name }}
      MOBILE_APP_VERSION: 1.0.0
      EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      LOCATION_SERVICE_EMAIL: ${{ secrets.LOCATION_SERVICE_EMAIL }}
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
      - name: 🔐 Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: 📦 Install Node Modules
        run: make run-command-install-node-packages
      - name: Generate env file
        run: make run-command-generate-env-file
      - name: Build App
        run: make run-command-build-mobile
