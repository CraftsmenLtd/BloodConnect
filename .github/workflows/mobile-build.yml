name: üì± Mobile App Build

on:
  workflow_call:
    inputs:
      docker_image:
        description: "The runner image to be used"
        required: true
        type: string
      github_environment:
        description: "Defines the GitHub environment for secrets"
        required: true
        type: string
      deployment_environment:
        description: "Defines the deployment environment for Makefile"
        required: true
        type: string
      app_version:
        description: "Mobile app version"
        required: true
        type: string
      eas_project_id:
        description: "EAS project ID"
        required: true
        type: string
      expo_token:
        description: "Expo service token"
        required: true
        type: string
      location_service_email:
        description: "Geolocation service email"
        required: true
        type: string

permissions:
  contents: read
  packages: write
  id-token: write

defaults:
  run:
    shell: bash

jobs:
  build-app:
    name: Build App
    needs: [setup-environment, build-push-docker-image]
    runs-on: ${{ vars.RUNNER_OS }}
    environment: ${{ inputs.github_environment }}
    env:
      RUNNER_IMAGE_NAME: ${{ inputs.docker_image }}
      DEPLOYMENT_ENVIRONMENT: ${{ inputs.deployment_environment }}
      MOBILE_APP_VERSION: ${{ inputs.app_version }}
      EAS_PROJECT_ID: ${{ inputs.eas_project_id }}
      EXPO_TOKEN: ${{ inputs.expo_token }}
      LOCATION_SERVICE_EMAIL: ${{ inputs.location_service_email }}
    steps:
      - name: üì• Checkout Branch
        uses: actions/checkout@v4

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Install Node Modules
        run: make run-command-install-node-packages

      - name: üîë Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Generate env file
        run: make run-command-generate-env-file

      - name: Build App
        run: make run-command-build-mobile
