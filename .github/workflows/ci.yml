name: ğŸ§ª Continuous Integration

on:
  push:
    branches-ignore:
      - "master"

permissions:
  contents: read
  packages: write

defaults:
  run:
    shell: bash
      
concurrency:
  group: ${{ github.ref }}

env:
  ACTIONS_ALLOW_UNSECURE_COMMANDS: true

jobs:
  build-push-docker-image:
    name: ğŸ³ Build and Push Docker Image
    uses: ./.github/workflows/docker-image.yml
    secrets: inherit

  lint-test-security-checks:
    name: ğŸ§ª Lint, Test and Security Check
    needs: [build-push-docker-image]
    uses: ./.github/workflows/ci-checks.yml
    secrets: inherit
    with:
      runner_image_name: ${{ needs.build-push-docker-image.outputs.runner_image_name }}
      is_deploy_localstack: false

  end-to-end-test:
    name: End to End Test
    needs: [build-push-docker-image, lint-test-security-checks]
    runs-on: ${{ vars.RUNNER_OS }}
    environment: ci
    env:
      RUNNER_IMAGE_NAME: ${{ needs.build-push-docker-image.outputs.runner_image_name }}
      LOCALSTACK_AUTH_TOKEN: ${{ secrets.LOCALSTACK_AUTH_TOKEN }}
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§ª Run End to End Test
        run: make run-command-end-to-end
