name: EXPO Eas

on:
  workflow_call:
    inputs:
      docker_image:
        description: "The runner image to be used"
        required: true
        type: string
      deployment_environment:
        description: "Defines the Deployment Environment for branch"
        required: true
        type: string
      deployment_environment_group:
        description: "Defines the Deployment Environment Group for secrets"
        required: true
        type: string
      build_profile:
        description: "Defines the Build Profile For EXPO"
        required: true
        type: string
      aws_user_pool_client_id:
        description: "Defines aws_user_pool_client_id For EXPO"
        required: true
        type: string
      aws_user_pool_id:
        description: "Defines aws_user_pool_id For EXPO"
        required: true
        type: string
      api_base_url:
        description: "Defines api_base_url For EXPO"
        required: true
        type: string
      aws_cognito_domain:
        description: "Defines aws_cognito_domain For EXPO"
        required: true
        type: string
      encoded_google_services_file:
        description: "Defines B64 encoded google services file"
        required: true
        type: string
      build_type:
        description: "Defines if this is a local or expo build"
        required: true
        type: string
permissions:
  contents: read
  packages: write
  id-token: write

defaults:
  run:
    shell: bash

env:
  ACTIONS_ALLOW_UNSECURE_COMMANDS: true

jobs:
  expo-eas:
    name: 📱 EXPO Eas
    runs-on: ${{ vars.RUNNER_OS }}
    environment: ${{ inputs.deployment_environment_group }}
    env:
      RUNNER_IMAGE_NAME: ${{ inputs.docker_image }}
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      BUILD_PROFILE: ${{ inputs.build_profile }}
      EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
      APP_NAME: net.bloodconnect.app
      APP_VERSION: 1.1.2
      AWS_USER_POOL_CLIENT_ID: ${{ inputs.aws_user_pool_client_id }}
      AWS_USER_POOL_ID: ${{ inputs.aws_user_pool_id }}
      API_BASE_URL: ${{ inputs.api_base_url }}
      AWS_COGNITO_DOMAIN: ${{ inputs.aws_cognito_domain }}

    steps:
      - name: 📥 Checkout Branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔐 Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 📦 Install React Native Modules
        run: make run-command-install-node-packages

      - name: 📥 Decode Google Service File from Input
        run: |
            echo "${{ inputs.encoded_google_services_file }}" | \
            base64 --decode | \
            sudo openssl enc -aes-256-cbc -pbkdf2 -iter 100000 -d -salt \
              -pass pass:${{ secrets.ENCRYPTION_KEY }} | \
            sudo tee clients/mobile/google-services.json > /dev/null

      - name: ⏳ Start Expo Eas Build Job
        run: make run-command-build-android
        if: ${{ inputs.build_type == 'eas' }}

      - name: ⚙️ Build Expo Locally
        run: make run-command-build-android-local
        if: ${{ inputs.build_type == 'local' }}

      - name: 📁 Upload apk
        uses: actions/upload-artifact@v4
        with:
          name:  ${{ env.APP_NAME }}-${{ env.APP_VERSION }}.apk
          path: clients/mobile/*.apk
