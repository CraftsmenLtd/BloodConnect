name: EXPO Eas

on:
  workflow_call:
    inputs:
      docker_image:
        description: "The runner image to be used"
        required: true
        type: string
      deployment_environment_group:
        description: "Defines the Deployment Environment Group for secrets"
        required: true
        type: string
      build_profile:
        description: "Defines the Build Profile For EXPO"
        required: true
        type: string

permissions:
  contents: read
  packages: write
  id-token: write

defaults:
  run:
    shell: bash

env:
  ACTIONS_ALLOW_UNSECURE_COMMANDS: true

jobs:
  expo-eas:
    name: EXPO Eas
    runs-on: ${{ vars.RUNNER_OS }}
    environment: ${{ inputs.deployment_environment_group }}
    env:
      RUNNER_IMAGE_NAME: ${{ inputs.docker_image }}
      EXPO_TOKEN: ${{ secrets.EXPO_SECRETS }}
      BUILD_PROFILE: ${{ inputs.build_profile }}
      EAS_PROJECT_ID: ${{ secrets.EAS_PROJECT_ID }}
    steps:
      - name: üì• Checkout Branch
        uses: actions/checkout@v4

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Install React Native Modules
        run: make run-command-install-native-packages

      - name: üì§ Upload environment variables
        run: make run-command-upload-env
      
      - name: ‚è≥ Start expo build job
        run: make run-command-upload-env
